language: cpp
dist: trusty
sudo: false

notifications:
  email: false

git:
  submodules: false

matrix:
  include:
  - os: linux
    compiler: gcc
    addons:
      apt:
        sources: ['ubuntu-toolchain-r-test']
        packages: [g++-4.9, 'python-pip', 'python-yaml', 'libssl1.0.0']
    before_install:
    - python --version
    - python -c 'import ssl; print ssl.OPENSSL_VERSION;'
    - sudo add-apt-repository ppa:webkit-team/ppa -y
    - sudo apt-get update
    - sudo apt-get install -y pkg-config libedit-dev libfreetype6-dev libx11-dev libxrandr-dev libxinerama1 libxinerama-dev libxcursor-dev libasound2-dev libgtk-3-dev libwebkit2gtk-4.0-dev
    install:
    - export CXX=g++-4.9 # make sure CXX is correctly set
    - git submodule update --init --recursive
    - pip install --user cpp-coveralls
    # BOOST
    - cd $TRAVIS_BUILD_DIR/ThirdParty
    - curl -L https://sourceforge.net/projects/boost/files/boost/1.63.0/boost_1_63_0.tar.gz -o ./boost.tar.gz
    - tar zxf ./boost.tar.gz && mv ./boost_1_63_0 boost && cd boost
    - ./bootstrap.sh toolset=gcc link=static
    - ./b2 --with-system stage
    # LLVM
    - cd $TRAVIS_BUILD_DIR/ThirdParty
    - curl -o ./llvm.tar.xz http://releases.llvm.org/5.0.0/clang+llvm-5.0.0-linux-x86_64-ubuntu14.04.tar.xz
    - tar xvf ./llvm.tar.xz && mv ./clang+llvm-5.0.0-linux-x86_64-ubuntu14.04 llvm
    # FLIP
    - cd $TRAVIS_BUILD_DIR
    - python ./Scripts/flip.py
    script:
    - cd $TRAVIS_BUILD_DIR
    - mkdir Build && cd Build
    - cmake .. -DCMAKE_C_FLAGS=-m64 -DUSE_LLVM_CONFIG=off -DLLVM_DIR=./ThirdParty/llvm/lib/cmake/llvm -DCMAKE_BUILD_TYPE=Debug -DGCOV_SUPPORT=On
    - cmake --build . --config Debug
    after_success:
    - coveralls -i Modules --gcov-options '\-lp' > /dev/null

  - os: linux
    compiler: gcc
    addons:
      apt:
        sources: ['ubuntu-toolchain-r-test']
        packages: [g++-4.9, 'python-pip', 'python-yaml', 'libssl1.0.0']
    before_install:
    - python --version
    - python -c 'import ssl; print ssl.OPENSSL_VERSION;'
    - sudo add-apt-repository ppa:webkit-team/ppa -y
    - sudo apt-get update
    - sudo apt-get install -y pkg-config libedit-dev libfreetype6-dev libx11-dev libxrandr-dev libxinerama1 libxinerama-dev libxcursor-dev libasound2-dev libgtk-3-dev libwebkit2gtk-4.0-dev
    install:
    - export CXX=g++-4.9 # make sure CXX is correctly set
    - git submodule update --init --recursive
    # BOOST
    - cd $TRAVIS_BUILD_DIR/ThirdParty
    - curl -L https://sourceforge.net/projects/boost/files/boost/1.63.0/boost_1_63_0.tar.gz -o ./boost.tar.gz
    - tar zxf ./boost.tar.gz && mv ./boost_1_63_0 boost && cd boost
    - ./bootstrap.sh toolset=gcc link=static
    - ./b2 --with-system stage
    # LLVM
    - cd $TRAVIS_BUILD_DIR/ThirdParty
    - curl -o ./llvm.tar.xz http://releases.llvm.org/5.0.0/clang+llvm-5.0.0-linux-x86_64-ubuntu14.04.tar.xz
    - tar xvf ./llvm.tar.xz && mv ./clang+llvm-5.0.0-linux-x86_64-ubuntu14.04 llvm
    # FLIP
    - cd $TRAVIS_BUILD_DIR
    - python ./Scripts/flip.py
    script:
    - cd $TRAVIS_BUILD_DIR
    - mkdir Build && cd Build
    - cmake .. -DCMAKE_C_FLAGS=-m64 -DUSE_LLVM_CONFIG=off -DLLVM_DIR=./ThirdParty/llvm/lib/cmake/llvm -DCMAKE_BUILD_TYPE=Release
    - cmake --build . --config Release
    before_deploy:
    - mkdir Kiwi && mv Build/Release/KiwiBuild/Kiwi Kiwi/Kiwi
    - zip -r Kiwi_$os.zip Kiwi
    - mkdir Kiwi_Server && mv Build/Release/KiwiBuild/Server Kiwi_Server/Server
    - zip -r Kiwi_server_$os.tar.gz Kiwi_Server

  - os: osx
    compiler: clang++
    osx_image: xcode9.2
    before_install:
    - pyenv install 2.7.11
    - pyenv global 2.7.11
    - eval "$(pyenv init -)"
    - python --version
    - python -c 'import ssl; print ssl.OPENSSL_VERSION;'
    install:
    - git submodule update --init --recursive
    # BOOST
    - cd $TRAVIS_BUILD_DIR/ThirdParty
    - curl -L https://sourceforge.net/projects/boost/files/boost/1.63.0/boost_1_63_0.tar.gz -o ./boost.tar.gz
    - tar zxf ./boost.tar.gz && mv ./boost_1_63_0 boost && cd boost
    - ./bootstrap.sh toolset=clang macosx-version-min=10.9 link=static
    - ./b2 address-model=64 --with-system stage
    # LLVM
    - cd $TRAVIS_BUILD_DIR/ThirdParty
    - curl http://releases.llvm.org/5.0.0/clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz -o ./llvm.tar.xz
    - tar zxf ./llvm.tar.xz && mv ./clang+llvm-5.0.0-x86_64-apple-darwin llvm
    # FLIP
    - cd $TRAVIS_BUILD_DIR
    - python ./Scripts/flip.py
    script:
    - cd $TRAVIS_BUILD_DIR
    - mkdir Build && cd Build
    - cmake .. -GXcode  -DUSE_LLVM_CONFIG=off -DLLVM_DIR=./ThirdParty/llvm/lib/cmake/llvm
    - cmake --build . --config Release
    before_deploy:
    - mkdir Kiwi && mv Build/Release/KiwiBuild/Release/Kiwi.app Kiwi/Kiwi.app
    - zip -r Kiwi_$os.zip Kiwi
    - mkdir Kiwi_Server && mv Build/Release/KiwiBuild/Release/Server Kiwi_Server/Server
    - zip -r Kiwi_server_$os.zip Kiwi_Server

# Deploy Release
deploy:
  provider: releases
  api_key:
    secure: atcBDMdJNzUGiUYSqQu/URg8mfvRk9b78tvj1eHKCeDXSTP0Y1UvI5YpmTx8SkUXp23QH4sgp0tKTFB98FbRojR4IL2NW+KZDG1o5BxZ4HYJ4hdCXXXhzeujcn2AjQzRJ9f8uodX/7Pfa19jGlovj1Tl9ZJ9jIfyyvcxlJXkTN9+CDlkkcpLNU64c4B+CclS8aLPbIKqvLmIy3fphzzkJoKN5rnE4EvKrIkJBPEib1WIY8K7W8boCwghsGBs04MwRZwidKIjPSPgbYpmGPspfKpu0W8mKMirdGEVt4rzpm+Dl9wMa/5Qsyc6afYfS4p3PZOfBio0mtVrPz4+4VXy/Ad+FDNnvxUy9776D0pSv2iBrdHhqs6n1vG0uT4uhbGtvwJR3BBbo6+TmEKakRgp+uRhYEvGy/EO0OkcKrOVLsrZ/akj8O+KOSROrz2VYfxmDTxtUi8K51vW3pJhcGsEsN1FkcJfef/pvxGLK5i0qEZWoyCyA4YMPNDWFFiuBadPTujIGJ/iDmwouzalV9F0vKOIFvP9IuZ1FHLOyEzhyoBS3l1NNpQUz+HNgupTVYSREH1qPXUHg3B5BdFpEJpOjU/P8gwG4npcNxX/5XvigFFiTeEN+eV4xcBVLcg+SsumeswIqi5Tvm+mzYyqz3wj628ddWxgGiPFSfySI4tz6lg=
  file:
  - Kiwi_$os.zip
  - Kiwi_server_$os.zip
  skip_cleanup: true
  draft: true
  prerelease: false
  on:
    repo: Musicoll/Kiwi
    tags: true
    branch: master

# Deploy Draft
deploy:
  provider: releases
  api_key:
    secure: atcBDMdJNzUGiUYSqQu/URg8mfvRk9b78tvj1eHKCeDXSTP0Y1UvI5YpmTx8SkUXp23QH4sgp0tKTFB98FbRojR4IL2NW+KZDG1o5BxZ4HYJ4hdCXXXhzeujcn2AjQzRJ9f8uodX/7Pfa19jGlovj1Tl9ZJ9jIfyyvcxlJXkTN9+CDlkkcpLNU64c4B+CclS8aLPbIKqvLmIy3fphzzkJoKN5rnE4EvKrIkJBPEib1WIY8K7W8boCwghsGBs04MwRZwidKIjPSPgbYpmGPspfKpu0W8mKMirdGEVt4rzpm+Dl9wMa/5Qsyc6afYfS4p3PZOfBio0mtVrPz4+4VXy/Ad+FDNnvxUy9776D0pSv2iBrdHhqs6n1vG0uT4uhbGtvwJR3BBbo6+TmEKakRgp+uRhYEvGy/EO0OkcKrOVLsrZ/akj8O+KOSROrz2VYfxmDTxtUi8K51vW3pJhcGsEsN1FkcJfef/pvxGLK5i0qEZWoyCyA4YMPNDWFFiuBadPTujIGJ/iDmwouzalV9F0vKOIFvP9IuZ1FHLOyEzhyoBS3l1NNpQUz+HNgupTVYSREH1qPXUHg3B5BdFpEJpOjU/P8gwG4npcNxX/5XvigFFiTeEN+eV4xcBVLcg+SsumeswIqi5Tvm+mzYyqz3wj628ddWxgGiPFSfySI4tz6lg=
  file:
  - Kiwi_$os.zip
  - Kiwi_server_$os.zip
  skip_cleanup: true
  draft: true
  prerelease: false
  name: ${TRAVIS_TAG}
  tag_name: ${TRAVIS_TAG}
  on:
    repo: Musicoll/Kiwi
    tags: true
    condition: $TRAVIS_BRANCH != "master"
