<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Flip Basics Programming Guide: Model Versioning</title>
<style>
* {font-family: 'Lucida Grande', Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
body {background-color: #fff; }
p {color: black; font-size: 13px; margin-bottom: 10px;}
h1 {color: black; font-size: 28px; margin-bottom: 32px; padding-top: 24px; font-weight: normal; display: block; }
h2 {color: #3c4c6c; display: block; font-size: 24px; font-weight: normal; margin-bottom: 20px; margin-top: 42px; border-bottom-color: #8391a8; border-bottom-style: solid; border-bottom-width: 1px;}
h3 {color: black; font-size: 19px; margin-bottom: 4px; margin-top: 28px; font-weight: normal; display: block; }
a {color: #36c; text-decoration: none; cursor:pointer; }
a:active {color: #36c; text-decoration: none; cursor:pointer; }
a:hover {color: #36c; text-decoration: underline; cursor:pointer; }
.aerr {color: #f00}
h2 a {color: #3c4c6c; text-decoration: none; cursor:auto; }
h2 a:active {color: #3c4c6c; text-decoration: none; cursor:auto; }
h2 a:hover {color: #3c4c6c; text-decoration: none; cursor:auto; }
h3 a {color: black; text-decoration: none; cursor:auto; }
h3 a:active {color: black; text-decoration: none; cursor:auto; }
h3 a:hover {color: black; text-decoration: none; cursor:auto; }
footer {font-size: 10px; position: fixed; display: block; bottom: 0px; background-color: #f1f5f9; border-top-color: #c7cfd5; border-top-style: solid; border-top-width: 1px; width: 100%; height:22px; padding-top: 7px; padding-left: 7px;}
div {display: block;}
.codeblock {margin-top:17px; margin-bottom:17px; clear: both; display: block; color: #333; }
pre {font-family: Courier, Consolas, monospace; font-size: 12px; height: 14px; line-height: 14px; margin-bottom: 0px; margin-left: 6px; margin-right: 4px; margin-top: -1px;}
small pre {color:#888;}
emph pre {color:#000;}
table {padding-top:5px; padding-bottom:6px; margin-bottom:12px; background-color: #f1f5f9; border-color: #c7cfd5; border-style: solid; border-width: 1px; width: 100%;}
tr {}
td > p {margin-left: 6px; height: 12px;}
.note {margin-top:21px; margin-bottom:22px; padding-left: 8px; padding-right: 8px; background-color: #fff; border-color: #5088c5; border-style: solid; border-width: 1px; display: block;}
.note strong {margin-right: 8px;}
.note p {margin-top: 7px;}
.important {margin-top:21px; margin-bottom:22px; padding-left: 8px; padding-right: 8px; background-color: #f1f5f9; border-color: #5088c5; border-style: solid; border-width: 1px; display: block;}
.important strong {margin-right: 8px;}
.important p {margin-top: 7px;}
.warning {margin-top:21px; margin-bottom:22px; padding-left: 8px; padding-right: 8px; background-color: #f8e3e1; border-color: #c5443e; border-style: solid; border-width: 1px; display: block;}
.warning strong {margin-right: 8px;}
.warning p {margin-top: 7px;}
.caption p {color: black; font-size: 10px; margin-bottom: 10px;}
img {margin-top:10px; margin-bottom:10px;}
ul {margin-left: 17px; margin-bottom: 10px;}
ol {margin-left: 17px; margin-bottom: 10px;}
li {color: black; font-size: 13px; margin-bottom: 7px;}
code {font-family: Courier, Consolas, monospace;}
#content {padding-left: 26px; padding-right: 26px; position: absolute; top: 30px; left: 230px; width: 750px;}
#toc {width: 230px; position: fixed; top: 30px; background-color: #f1f5f9; height: 100%; border-right-color: #c7cfd5; border-right-style: solid; border-right-width: 1px; padding-left: 0px; padding-top: 17px; overflow: auto;}
#toc > ul {list-style-type: none;}
#toc > ul > li {font-size: 11px; }
#toc > ul > li > ul {list-style-type: none; margin-top:8px;}
#toc > ul > li > ul > li {font-size: 11px; }
#toc > p {font-size: 13px; margin-left: 17px;}
.codeblock > p {margin-bottom: 3px; font-size: 11px;}
.codeblock > p > strong {margin-right: 10px; color: #222;}
.nav {font-size: 10px; margin-top: 20px; }
.nav > span {margin-right: 20px;}
.bottomspacer {height:100px;}
#header {width:100%; position: fixed; background-color: #111; height: 30px; z-index: 900;}
#header > p {color:#fff; font-size: 13px; padding-top: 6px; padding-left: 17px; }
#header > p > a {color:#fff; font-size: 13px; text-decoration: none; cursor:pointer; padding-right: 56px;}
.sectioncode {background-color: #f6f6f6; padding: 12px; margin-top: 18px;}
.sectioncode > h3 {margin-top: 0px; padding-bottom: 8px;}
hr { display: block; height: 1px; border: 0; border-top: 1px solid #eee; margin: 28px 0; padding: 0; }</style>
</head>

<body>

<div id="header">
<div style="width: 1006px;"></div>
<p><a href="../index.html">Flip Documentation Library</a><a href="../guide/index.html">Flip Basics Programming Guide</a></p>
</div>
<div id="toc">
<p>Flip Basics Programming Guide</p>
<ul>
<li><a href="../guide/about.html">About Flip Programming Guide</a></li>
<li><a href="../guide/declare.html">Declaring the Model</a></li>
<li><a href="../guide/organize.html">Organizing your Code</a></li>
<li><a href="../guide/control.html">Controlling the Model</a></li>
<li><a href="../guide/observe.html">Observing the Model</a></li>
<li><a href="../guide/signal.html">Signalling the Model</a></li>
<li><a href="../guide/remote.html">Working with a Remote Server</a></li>
<li><a href="../guide/misc.html">More Fun with Flip</a></li>
<li><a href="../guide/conversion.html">Model Versioning</a>	<ul>
	<li><a href="../guide/conversion.html#converters">Converters</a></li>
	<li><a href="../guide/conversion.html#dispatch">Conversion graph</a></li>
	<li><a href="../guide/conversion.html#converter">Converter</a></li>
	</ul>
</li>
</ul>
</div>

<div id="content">
<div class="nav" align="right">
<a href="misc.html">previous</a></div>

<h1>Model Versioning</h1>

<p>Over time, your model will change, and so its revision. Document then needs to be converted, and this chapter describes how to do so.</p>

<h2><a name="converters">Converters</a></h2>

<p>Your <code>model</code> folder should contain a <code>conv</code> folder. It will contains all your format version changes in a single place. Since Flip format conversion system is rather flexible, it is very easy to make document format changes, so you are very likely to make a lot of them.</p>

<p>You should name your conversion classes <code>Converter#1_#2</code> where <code>#1</code> would be the initial revision, according to your version source control naming. In the same fashion, <code>#2</code> would be your destination revision.</p>

<h2><a name="dispatch">Conversion graph</a></h2>

<p>Just after reading a serialized document in <code>BackEndMl</code> or <code>BackEndBinary</code> to the <code>BackEndIR</code> format, you need to convert the latter format to the revision of the model currently used in your application.</p>

<p><code>BackEndMl</code> or <code>BackEndBinary</code> are model revision agnostic, and so is <code>BackEndIR</code>, so that you don't need to maintain all versions of the model to be able to convert.</p>

<p>The general idea is to convert from one conversion to another the <code>BackEndIR</code> format until you've matched the revision available to use with your application.</p>

<p>Typically, this global conversion process looks like this :</p>

<div class="codeblock"><table>
<tr><td><pre>DataProviderFile provider (&quot;/path/to/file&quot;);</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>// tell the backend to automatically recognize the binary format</pre></td></tr>
<tr><td><pre>BackEndIR backend;</pre></td></tr>
<tr><td><pre>backend.register_backend &lt;BackEndBinary&gt; ();</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>bool ok_flag = backend.read (provider);</pre></td></tr>
<tr><td><pre>if (!ok_flag) return;   // a corruption occured</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>// now starts the conversion process, where every converters process</pre></td></tr>
<tr><td><pre>// the &apos;backend&apos; in-place, and changes its version</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>if (backend.version == &quot;myapp.beta.1&quot;)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   Converter_beta1_beta2 converter;</pre></td></tr>
<tr><td><pre>   converter.process (backend);</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   // now backend.version == &quot;myapp.beta.2&quot;</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>if (backend.version == &quot;myapp.beta.3&quot;)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   // beta.3 was a mistake, so we decide to rollback it to beta.2</pre></td></tr>
<tr><td><pre>   // for our loyal beta testers</pre></td></tr>
<tr><td><pre>   Converter_beta3_beta2 converter;</pre></td></tr>
<tr><td><pre>   converter.process (backend);</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   // now backend.version == &quot;myapp.beta.2&quot;</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>if (backend.version == &quot;myapp.beta.2&quot;)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   Converter_beta2_r100 converter;</pre></td></tr>
<tr><td><pre>   converter.process (backend);</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   // now backend.version == &quot;myapp.r100&quot;</pre></td></tr>
<tr><td><pre>   // which is the current model revision</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>Document document (Model::use (), user_id, manufacturer_id, component_id);</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>// change the document with the content of the backend</pre></td></tr>
<tr><td><pre>document.read (backend);</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>// commit the changes</pre></td></tr>
<tr><td><pre>document.commit ();</pre></td></tr>
</table></div>

<h2><a name="converter">Converter</a></h2>

<div class="note"><p><strong>Note:</strong> For now the conversion process is done entirely manually, and require deep    knowledge of the internals of Flip. It will be soon simplified by using    dedicated tool classes.</p></div>

<p>Now that we have seen the global conversion graph managment, let's look at a single converter anatomy.</p>

<p><code>BackEndIR</code> contains a member <code>version</code> string which is the current revision of the model. A part from that, it contains a member <code>root</code> which is the starting point of every conversions.</p>

<p><code>root</code> itself is a <code>BackEndIR::Type</code> which is a generic way to represent a <code>Type</code> in the document. It can represent either an <code>Object</code>, but also a container type or a basic type like <code>Float</code>.</p>

<p><code>Type</code> contains a <code>type_name</code> as well as a <code>type_id</code> to allows to know which kind of type we are manipulating.</p>

<ul>
<li>If the <code>Type</code> is an object, then <code>Type::members</code> is the list of the members of the object</li>
<li>If the <code>Type</code> is an array, then <code>Type::array</code> is the list of the element of the array</li>
<li>If the <code>Type</code> is a collection, then <code>Type::collection</code> is the list of the element of the collection</li>
<li>If the <code>Type</code> is a value type like <code>Float</code>, then <code>Type::value</code> is the value</li>
</ul>

<p>For example let's say that we had the following model :</p>

<div class="codeblock"><table>
<tr><td><pre>class Note : public Object</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>public:</pre></td></tr>
<tr><td><pre>   String title;</pre></td></tr>
<tr><td><pre>   String body;</pre></td></tr>
<tr><td><pre>};</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>class Root : public Object</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>public:</pre></td></tr>
<tr><td><pre>   Collection &lt;Note&gt; notes;</pre></td></tr>
<tr><td><pre>};</pre></td></tr>
</table></div>

<p>And that we want to convert to this new model, where we added a member <code>date</code></p>

<div class="codeblock"><table>
<tr><td><pre>class Note : public Object</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>public:</pre></td></tr>
<tr><td><pre>   String title;</pre></td></tr>
<tr><td><pre>   String body;</pre></td></tr>
<tr><td><pre>   String date;</pre></td></tr>
<tr><td><pre>};</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>class Root : public Object</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>public:</pre></td></tr>
<tr><td><pre>   Collection &lt;Note&gt; notes;</pre></td></tr>
<tr><td><pre>};</pre></td></tr>
</table></div>

<p>Then the converter will need to add a member and initialize it to a value this way :</p>

<div class="codeblock"><table>
<tr><td><pre>void  Converter::process (BackEndIR backend)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   std::string current_date = today ();</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   for (auto &amp; element : backend.root.collection)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      auto &amp; note = element.second;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>      auto &amp; date = *note.members.emplace_back (std::make_pair (&quot;date&quot;, Type ()));</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>      date.type_name = &quot;flip.Blob&quot;; // String is a Blob</pre></td></tr>
<tr><td><pre>      date.type_id = TypeId::BLOB;</pre></td></tr>
<tr><td><pre>      date.value.blob.assign (current_date.begin (), current_date.end ());</pre></td></tr>
<tr><td><pre>      date.value.blob_string_flag = true;</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table></div>

<div class="nav" align="right">
<a href="misc.html">previous</a></div>

<div class="bottomspacer">&nbsp;</div>
</div>
</body>
</html>
