<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Flip History Strategy Guide: Handling a Non-deterministic Gesture</title>
<style>
* {font-family: 'Lucida Grande', Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
body {background-color: #fff; }
p {color: black; font-size: 13px; margin-bottom: 10px;}
h1 {color: black; font-size: 28px; margin-bottom: 32px; padding-top: 24px; font-weight: normal; display: block; }
h2 {color: #3c4c6c; display: block; font-size: 24px; font-weight: normal; margin-bottom: 20px; margin-top: 42px; border-bottom-color: #8391a8; border-bottom-style: solid; border-bottom-width: 1px;}
h3 {color: black; font-size: 19px; margin-bottom: 4px; margin-top: 28px; font-weight: normal; display: block; }
a {color: #36c; text-decoration: none; cursor:pointer; }
a:active {color: #36c; text-decoration: none; cursor:pointer; }
a:hover {color: #36c; text-decoration: underline; cursor:pointer; }
.aerr {color: #f00}
h2 a {color: #3c4c6c; text-decoration: none; cursor:auto; }
h2 a:active {color: #3c4c6c; text-decoration: none; cursor:auto; }
h2 a:hover {color: #3c4c6c; text-decoration: none; cursor:auto; }
h3 a {color: black; text-decoration: none; cursor:auto; }
h3 a:active {color: black; text-decoration: none; cursor:auto; }
h3 a:hover {color: black; text-decoration: none; cursor:auto; }
footer {font-size: 10px; position: fixed; display: block; bottom: 0px; background-color: #f1f5f9; border-top-color: #c7cfd5; border-top-style: solid; border-top-width: 1px; width: 100%; height:22px; padding-top: 7px; padding-left: 7px;}
div {display: block;}
.codeblock {margin-top:17px; margin-bottom:17px; clear: both; display: block; color: #333; }
pre {font-family: Courier, Consolas, monospace; font-size: 12px; height: 14px; line-height: 14px; margin-bottom: 0px; margin-left: 6px; margin-right: 4px; margin-top: -1px;}
small pre {color:#888;}
emph pre {color:#000;}
table {padding-top:5px; padding-bottom:6px; margin-bottom:12px; background-color: #f1f5f9; border-color: #c7cfd5; border-style: solid; border-width: 1px; width: 100%;}
tr {}
td > p {margin-left: 6px; height: 12px;}
.note {margin-top:21px; margin-bottom:22px; padding-left: 8px; padding-right: 8px; background-color: #fff; border-color: #5088c5; border-style: solid; border-width: 1px; display: block;}
.note strong {margin-right: 8px;}
.note p {margin-top: 7px;}
.important {margin-top:21px; margin-bottom:22px; padding-left: 8px; padding-right: 8px; background-color: #f1f5f9; border-color: #5088c5; border-style: solid; border-width: 1px; display: block;}
.important strong {margin-right: 8px;}
.important p {margin-top: 7px;}
.warning {margin-top:21px; margin-bottom:22px; padding-left: 8px; padding-right: 8px; background-color: #f8e3e1; border-color: #c5443e; border-style: solid; border-width: 1px; display: block;}
.warning strong {margin-right: 8px;}
.warning p {margin-top: 7px;}
.caption p {color: black; font-size: 10px; margin-bottom: 10px;}
img {margin-top:10px; margin-bottom:10px;}
ul {margin-left: 17px; margin-bottom: 10px;}
ol {margin-left: 17px; margin-bottom: 10px;}
li {color: black; font-size: 13px; margin-bottom: 7px;}
code {font-family: Courier, Consolas, monospace;}
#content {padding-left: 26px; padding-right: 26px; position: absolute; top: 30px; left: 230px; width: 750px;}
#toc {width: 230px; position: fixed; top: 30px; background-color: #f1f5f9; height: 100%; border-right-color: #c7cfd5; border-right-style: solid; border-right-width: 1px; padding-left: 0px; padding-top: 17px; overflow: auto;}
#toc > ul {list-style-type: none;}
#toc > ul > li {font-size: 11px; }
#toc > ul > li > ul {list-style-type: none; margin-top:8px;}
#toc > ul > li > ul > li {font-size: 11px; }
#toc > p {font-size: 13px; margin-left: 17px;}
.codeblock > p {margin-bottom: 3px; font-size: 11px;}
.codeblock > p > strong {margin-right: 10px; color: #222;}
.nav {font-size: 10px; margin-top: 20px; }
.nav > span {margin-right: 20px;}
.bottomspacer {height:100px;}
#header {width:100%; position: fixed; background-color: #111; height: 30px; z-index: 900;}
#header > p {color:#fff; font-size: 13px; padding-top: 6px; padding-left: 17px; }
#header > p > a {color:#fff; font-size: 13px; text-decoration: none; cursor:pointer; padding-right: 56px;}
.sectioncode {background-color: #f6f6f6; padding: 12px; margin-top: 18px;}
.sectioncode > h3 {margin-top: 0px; padding-bottom: 8px;}
hr { display: block; height: 1px; border: 0; border-top: 1px solid #eee; margin: 28px 0; padding: 0; }</style>
</head>

<body>

<div id="header">
<div style="width: 1006px;"></div>
<p><a href="../index.html">Flip Documentation Library</a><a href="../history/index.html">Flip History Strategy Guide</a></p>
</div>
<div id="toc">
<p>Flip History Strategy Guide</p>
<ul>
<li><a href="../history/about.html">About Flip History Strategy Guide</a></li>
<li><a href="../history/setup.html">Setting up the History</a></li>
<li><a href="../history/simple.html">Handling a Simple Modification</a></li>
<li><a href="../history/gesture.html">Handling a Gesture</a></li>
<li><a href="../history/gesture2.html">Handling a Non-deterministic Gesture</a>	<ul>
	<li><a href="../history/gesture2.html#overview">Overview</a></li>
	<li><a href="../history/gesture2.html#impl">Implementation</a></li>
	</ul>
</li>
</ul>
</div>

<div id="content">
<div class="nav" align="right">
<a href="gesture.html">previous</a></div>

<h1>Handling a Non-deterministic Gesture</h1>

<p>This chapter shows to implement a more complex gesture, that is an undo step that relates to multiple commits of the document when the end of the gesture cannot be known <em>a priori</em>.</p>

<h2><a name="overview">Overview</a></h2>

<p>One common modifications of the document occurs over a gesture. That is, the actual modification of the document integrates multiple commits, but the undo step and publication to the outside world happens once the gesture is said to be "finished".</p>

<p>Sometimes however, the "finished" state of a transaction cannot be determined <em>a priori</em>. This means that the user of the application might expect the last undo to extend over time, based on certain criteria.</p>

<p>Example of such modifications are :</p>

<ul>
<li>Modifying the properties of an object using the keyboard arrows, and wanting the undo action to revert all last keyboard actions</li>
</ul>

<p>The general idea of the modifications is that it spans over time. In this case the document is modified gradually as the gesture is performed. This allows on each commit to notify the observers so that the document views show an up-to-date of the document, even if this does not make the actual undo step stored in the history.</p>

<p>The undo step itself will be stored at each commit, like the simple undo case. However, this last undo step will be replaced as new actions are performed. For example, if the user moves an object on screen using the keyboard arrows 4 times, then the last undo is replaced with the equivalent full transaction representing the change from the very start. The user would then expect the undo action to revert its 4 actions to be reverted in one-step instead of each action.</p>

<h2><a name="impl">Implementation</a></h2>

<p>The following code illustrates such a modification of the document to change gradually the tempo of a song.</p>

<div class="codeblock"><table>
<tr><td><pre>Document document (Model::use (), 123456789UL, &apos;appl&apos;, &apos;gui &apos;);</pre></td></tr>
<tr><td><pre>History &lt;HistoryStoreMemory&gt; history (document);</pre></td></tr>
<tr><td><pre>Song &amp; song = document.root &lt;Song&gt; ();</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>[...]</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>song.tempo = song.tempo + 10.0;  (1)</pre></td></tr>
<tr><td><pre>auto tx = document.commit ();    (2)</pre></td></tr>
<tr><td><pre>history.add_undo_step (tx);      (3)</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>[...]</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>song.tempo = song.tempo + 10.0;  (4)</pre></td></tr>
<tr><td><pre>document.commit ();</pre></td></tr>
<tr><td><pre>auto tx = document.squash ();    (5)</pre></td></tr>
<tr><td><pre>*history.last_undo () = tx;      (6)</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>[...]</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>song.tempo = song.tempo + 10.0;  (4)</pre></td></tr>
<tr><td><pre>document.commit ();</pre></td></tr>
<tr><td><pre>auto tx = document.squash ();    (5)</pre></td></tr>
<tr><td><pre>*history.last_undo () = tx;      (6)</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>[...]</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>document.push ();                (7)</pre></td></tr>
</table></div>

<ol>
<li>After a keyboard event, increment the tempo by 10 bpm</li>
<li>Commit the change</li>
<li>Make a new undo step with this transaction</li>
<li>Increment the tempo by 10 bpm</li>
<li>Squash the push stack to make a single transaction out of the multiple commits</li>
<li>Replace the last undo step with the resulting transaction</li>
<li>At some point, the client of the library would advertise this document modification to       the outside world at that moment (for example when starting a new action)</li>
</ol>

<div class="nav" align="right">
<a href="gesture.html">previous</a></div>

<div class="bottomspacer">&nbsp;</div>
</div>
</body>
</html>
