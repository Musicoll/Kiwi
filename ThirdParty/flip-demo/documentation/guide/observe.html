<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Flip Basics Programming Guide: Observing the Model</title>
<style>
* {font-family: 'Lucida Grande', Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
body {background-color: #fff; }
p {color: black; font-size: 13px; margin-bottom: 10px;}
h1 {color: black; font-size: 28px; margin-bottom: 32px; padding-top: 24px; font-weight: normal; display: block; }
h2 {color: #3c4c6c; display: block; font-size: 24px; font-weight: normal; margin-bottom: 20px; margin-top: 42px; border-bottom-color: #8391a8; border-bottom-style: solid; border-bottom-width: 1px;}
h3 {color: black; font-size: 19px; margin-bottom: 4px; margin-top: 28px; font-weight: normal; display: block; }
a {color: #36c; text-decoration: none; cursor:pointer; }
a:active {color: #36c; text-decoration: none; cursor:pointer; }
a:hover {color: #36c; text-decoration: underline; cursor:pointer; }
.aerr {color: #f00}
h2 a {color: #3c4c6c; text-decoration: none; cursor:auto; }
h2 a:active {color: #3c4c6c; text-decoration: none; cursor:auto; }
h2 a:hover {color: #3c4c6c; text-decoration: none; cursor:auto; }
h3 a {color: black; text-decoration: none; cursor:auto; }
h3 a:active {color: black; text-decoration: none; cursor:auto; }
h3 a:hover {color: black; text-decoration: none; cursor:auto; }
footer {font-size: 10px; position: fixed; display: block; bottom: 0px; background-color: #f1f5f9; border-top-color: #c7cfd5; border-top-style: solid; border-top-width: 1px; width: 100%; height:22px; padding-top: 7px; padding-left: 7px;}
div {display: block;}
.codeblock {margin-top:17px; margin-bottom:17px; clear: both; display: block; color: #333; }
pre {font-family: Courier, Consolas, monospace; font-size: 12px; height: 14px; line-height: 14px; margin-bottom: 0px; margin-left: 6px; margin-right: 4px; margin-top: -1px;}
small pre {color:#888;}
emph pre {color:#000;}
table {padding-top:5px; padding-bottom:6px; margin-bottom:12px; background-color: #f1f5f9; border-color: #c7cfd5; border-style: solid; border-width: 1px; width: 100%;}
tr {}
td > p {margin-left: 6px; height: 12px;}
.note {margin-top:21px; margin-bottom:22px; padding-left: 8px; padding-right: 8px; background-color: #fff; border-color: #5088c5; border-style: solid; border-width: 1px; display: block;}
.note strong {margin-right: 8px;}
.note p {margin-top: 7px;}
.important {margin-top:21px; margin-bottom:22px; padding-left: 8px; padding-right: 8px; background-color: #f1f5f9; border-color: #5088c5; border-style: solid; border-width: 1px; display: block;}
.important strong {margin-right: 8px;}
.important p {margin-top: 7px;}
.warning {margin-top:21px; margin-bottom:22px; padding-left: 8px; padding-right: 8px; background-color: #f8e3e1; border-color: #c5443e; border-style: solid; border-width: 1px; display: block;}
.warning strong {margin-right: 8px;}
.warning p {margin-top: 7px;}
.caption p {color: black; font-size: 10px; margin-bottom: 10px;}
img {margin-top:10px; margin-bottom:10px;}
ul {margin-left: 17px; margin-bottom: 10px;}
ol {margin-left: 17px; margin-bottom: 10px;}
li {color: black; font-size: 13px; margin-bottom: 7px;}
code {font-family: Courier, Consolas, monospace;}
#content {padding-left: 26px; padding-right: 26px; position: absolute; top: 30px; left: 230px; width: 750px;}
#toc {width: 230px; position: fixed; top: 30px; background-color: #f1f5f9; height: 100%; border-right-color: #c7cfd5; border-right-style: solid; border-right-width: 1px; padding-left: 0px; padding-top: 17px; overflow: auto;}
#toc > ul {list-style-type: none;}
#toc > ul > li {font-size: 11px; }
#toc > ul > li > ul {list-style-type: none; margin-top:8px;}
#toc > ul > li > ul > li {font-size: 11px; }
#toc > p {font-size: 13px; margin-left: 17px;}
.codeblock > p {margin-bottom: 3px; font-size: 11px;}
.codeblock > p > strong {margin-right: 10px; color: #222;}
.nav {font-size: 10px; margin-top: 20px; }
.nav > span {margin-right: 20px;}
.bottomspacer {height:100px;}
#header {width:100%; position: fixed; background-color: #111; height: 30px; z-index: 900;}
#header > p {color:#fff; font-size: 13px; padding-top: 6px; padding-left: 17px; }
#header > p > a {color:#fff; font-size: 13px; text-decoration: none; cursor:pointer; padding-right: 56px;}
.sectioncode {background-color: #f6f6f6; padding: 12px; margin-top: 18px;}
.sectioncode > h3 {margin-top: 0px; padding-bottom: 8px;}
hr { display: block; height: 1px; border: 0; border-top: 1px solid #eee; margin: 28px 0; padding: 0; }</style>
</head>

<body>

<div id="header">
<div style="width: 1006px;"></div>
<p><a href="../index.html">Flip Documentation Library</a><a href="../guide/index.html">Flip Basics Programming Guide</a></p>
</div>
<div id="toc">
<p>Flip Basics Programming Guide</p>
<ul>
<li><a href="../guide/about.html">About Flip Programming Guide</a></li>
<li><a href="../guide/declare.html">Declaring the Model</a></li>
<li><a href="../guide/organize.html">Organizing your Code</a></li>
<li><a href="../guide/control.html">Controlling the Model</a></li>
<li><a href="../guide/observe.html">Observing the Model</a>	<ul>
	<li><a href="../guide/observe.html#declare">Declaring and Binding the Observer</a></li>
	<li><a href="../guide/observe.html#property">Listening to Property Changes</a></li>
	<li><a href="../guide/observe.html#container">Listening to Container Changes</a></li>
	<li><a href="../guide/observe.html#splice">Listening to Container Elements Move</a></li>
	</ul>
</li>
<li><a href="../guide/signal.html">Signalling the Model</a></li>
<li><a href="../guide/remote.html">Working with a Remote Server</a></li>
<li><a href="../guide/misc.html">More Fun with Flip</a></li>
<li><a href="../guide/conversion.html">Model Versioning</a></li>
</ul>
</div>

<div id="content">
<div class="nav" align="right">
<a href="control.html">previous</a><span>&nbsp;</span><a href="signal.html">next</a></div>

<h1>Observing the Model</h1>

<p>Now that we can declare a model and we know how to organize it and manipulate it, this chapter describes how to listen to its changes.</p>

<p>This chapter will use the model declared in the chapter <a href="../guide/observe.html#declare">Declaring the Model</a>.</p>

<h2><a name="declare">Declaring and Binding the Observer</a></h2>

<p>To listen to document modification, one must declare an observer.</p>

<p>All observers must inherit from the template class <code>DocumentObserver</code>, which takes the root class of your model as a template parameter.</p>

<p>To receive document changes, one must register a document observer to the document.</p>

<div class="note"><p><strong>Note:</strong> Only one observer can be setup per document, but an observer might dispatch itself to other observers if it wants to.</p></div>

<div class="codeblock"><table>
<tr><td><pre>class Observer : public flip::DocumentObserver &lt;Song&gt;                         (1)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>public:</pre></td></tr>
<tr><td><pre>   virtual void document_changed (Song &amp; song) override;                      (2)</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>void  run ()</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   Observer observer;</pre></td></tr>
<tr><td><pre>   Document document (Model::use (), observer, 123456789ULL, &apos;OmSt&apos;, &apos;gui &apos;); (3)</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   Song &amp; song = document.root &lt;Song&gt; ();</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   song.tempo = 120.0;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   document.commit ();                                                        (4)</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table></div>

<ol>
<li>Make an observer by inheriting from <code>DocumentObserver</code></li>
<li>Override the pure virtual function declared in <code>DocumentObserver</code></li>
<li>Attach the observer to the document</li>
<li>When <code>commit</code> is called, it will fire the <code>document_changed</code> method</li>
</ol>

<h2><a name="property">Listening to Property Changes</a></h2>

<p>When <code>commit</code> is called, it will fire the <code>document_changed</code> method. This method contains the song as a parameter. This song has then the ability to represent the document in its old state as well as new state.</p>

<p>Because of this property, Flip types can know when they have changed. Therefore, listening to tempo change in our example would look like this :</p>

<div class="codeblock"><table>
<tr><td><pre>void  Observer::document_changed (Song &amp; song)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   if (song.tempo.changed ())                   (1)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      double new_tempo = song.tempo;            (2)</pre></td></tr>
<tr><td><pre>      double old_tempo = song.tempo.before ();  (3)</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table></div>

<ol>
<li>Take the branch if the value was changed</li>
<li>Extract the new tempo value</li>
<li>Extract the old tempo value</li>
</ol>

<h2><a name="container">Listening to Container Changes</a></h2>

<p>Listening to container changes works in the same way. The container can know when it has changed. But the container also has the ability to represent both its old and new states.</p>

<div class="codeblock"><table>
<tr><td><pre>void  Observer::document_changed (Song &amp; song)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   if (song.tracks.changed ())</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      auto it = song.tracks.begin ();</pre></td></tr>
<tr><td><pre>      auto it_end = song.tracks.end ();</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>      for (; it != it_end ; ++it)</pre></td></tr>
<tr><td><pre>      {</pre></td></tr>
<tr><td><pre>         auto &amp; track = *it;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>         if (track.changed ())            (1)</pre></td></tr>
<tr><td><pre>         {</pre></td></tr>
<tr><td><pre>            if (track.added ())          (2)</pre></td></tr>
<tr><td><pre>            {</pre></td></tr>
<tr><td><pre>               ...</pre></td></tr>
<tr><td><pre>            }</pre></td></tr>
<tr><td><pre>            else if (track.resident ())   (3)</pre></td></tr>
<tr><td><pre>            {</pre></td></tr>
<tr><td><pre>               ...</pre></td></tr>
<tr><td><pre>            }</pre></td></tr>
<tr><td><pre>            else if (track.removed ())   (4)</pre></td></tr>
<tr><td><pre>            {</pre></td></tr>
<tr><td><pre>               ...</pre></td></tr>
<tr><td><pre>            }</pre></td></tr>
<tr><td><pre>         }</pre></td></tr>
<tr><td><pre>      }</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table></div>

<p>The code above will iterate other the list of tracks if it did change.</p>

<ol>
<li>Track life cycle is also detected through the use of <code>changed</code></li>
<li>The track was just added to the container</li>
<li>The track is resident, which means that it was neither added or removed from the container. Since the track itself changed (1), this means that it has inner modification</li>
<li>The track was removed from the container. Its data is still available to the observer, but the model object will be destroyed when <code>document_changed</code> exits.</li>
</ol>

<div class="note"><p><strong>Note:</strong> Traversing a <code>Collection</code> for changes is exactly similar to traversing an <code>Array</code>.</p></div>

<p>In the code above, a <code>Track</code> will be reported as changed when the <code>Track</code> changed itself, or one of its children, for example one <code>Clip</code> <code>position</code></p>

<div class="important"><p><strong>Important:</strong> When an object is <code>changed</code> this means that subtree it represents have changed, maybe somewhere deep in the tree.</p></div>

<h2><a name="splice">Listening to Container Elements Move</a></h2>

<p>Containers like <code>Array</code> or <code>Collection</code> have a <code>splice</code> operation which allows to move elements from one container or in the same container for <code>Array</code>.</p>

<p>If <code>splice</code> is used, then the document needs to be observed in a slightly different way, to be able to detect moves in the hierarchy.</p>

<p>An element moved is neither <code>added</code> or <code>removed</code> so it is resident. However the iterator that wrap the object can be also <code>added</code> or <code>removed</code>. When no splice operation is called, the iterator state is always the same as the element it wraps.</p>

<p>Then when an element is moving, the difference between the iterator state and the element state allows to observe moves, as shown in the example below.</p>

<div class="codeblock"><table>
<tr><td><pre>void  Observer::document_changed (Song &amp; song)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   if (song.tracks.changed ())</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      auto it = song.tracks.begin ();</pre></td></tr>
<tr><td><pre>      auto it_end = song.tracks.end ();</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>      for (; it != it_end ; ++it)</pre></td></tr>
<tr><td><pre>      {</pre></td></tr>
<tr><td><pre>         auto &amp; track = *it;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>         if (it.removed () &amp;&amp; track.resident ())</pre></td></tr>
<tr><td><pre>         {</pre></td></tr>
<tr><td><pre>            // The track is moving from this position...</pre></td></tr>
<tr><td><pre>         }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>         if (it.added () &amp;&amp; track.resident ())</pre></td></tr>
<tr><td><pre>         {</pre></td></tr>
<tr><td><pre>            // ... to this position</pre></td></tr>
<tr><td><pre>         }</pre></td></tr>
<tr><td><pre>      }</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table></div>

<p>The next chapter, <a href="../guide/signal.html">Signalling the Model</a> will show how to send non-persistent messages to objects of the model.</p>

<div class="nav" align="right">
<a href="control.html">previous</a><span>&nbsp;</span><a href="signal.html">next</a></div>

<div class="bottomspacer">&nbsp;</div>
</div>
</body>
</html>
